案例分析

---

# 淘宝网的架构演化

- 负载均衡 -> 应用服务器(Linux) -> Apache -> PHP -> MySQL (主从复制) 
- 负载均衡 -> 应用服务器(Linux) -> Weblogic-> Webx -> EJB -> IBatis -> Oracle、搜索引擎服务器集群
- 负载均衡 -> 应用服务器(Linux) -> JBoss -> Webx -> Spring -> Ibatis -> Oracle、搜索引擎服务器集群、分布式缓存
- Tair 分布式Key/Value存储引擎，分为持久化和非持久化两种使用方式
- TFS 分布式文件系统，适用于海量小文件存储
- OceanBase 分布式数据库系统，支持千亿级读写事务
- TDDL 对应用透明的分库分表层和具有众多特性的动态数据源

# 维基百科的高性能架构

- 架构主要组成
	- GeoDNS 基于开源域名服务器软件BIND的增强版本，可将域名解析到离用户最近的服务器
	- LVS 基于Linux的开源负载均衡服务器
	- Squid 基于Linux的开源反向代理服务器
	- Lighttpd 开源应用服务器，比Apache更轻量、更快速(作为图片服务器居多)
	- PHP 免费Web开放语言
	- Memcached 无中心高性能开源分布式缓存系统
	- Lucene Java开发的开源全文搜索引擎
	- MySQL 开源关系数据库
	
- 前端性能优化
	- DNS服务、CDN服务、反向代理服务、静态资源服务等
	- 核心是反向代理服务器Squid集群，请求通过LVS负载均衡分发到Squid服务器，热点词条被缓存，大量请求直接返回响应，无需发送到Apache服务器，Squid缓存不能命中的请求再通过LVS发送到Apache服务器，如果有词条更新，使用Invalidation Notification服务通知Squid缓存失效
	- CDN服务，位于反向代理Squid之前，很多热点词条缓存在CDN服务器上，CDN服务器不是这样离用户浏览器最近的地方
		- 页面内存不包含动态信息
		- 每个内容页面具有唯一的REST风格，避免重复缓存
		- 在HTML响应头写入缓存控制信息，通过应用控制内容是否缓存和有效期等

- 服务端性能优化
	- 硬件改善
	- 使用APC PHP字节码缓存模块，加速代码执行减少资源消耗
	- 使用Imagemagick进行图片处理和转化
	- 使用Tex进行文本格式化，特别是讲科学公式内容转换成图片格式
	- 替换PHP的字符串查找函数strtr()，使用更优化的算法重构
	
- 后端性能优化
	- 分布式缓存
		- 热点特别集中的数据直接缓存到应用服务器的本地内存中
		- 缓存数据的内容尽量是应用服务器可以直接使用的格式
		- 使用缓存服务器存储session对象
		- 使用Memcached
	- MySQL优化
		- 使用较大的服务器内存
		- 使用RAID0磁盘阵列以加速磁盘访问(降低了数据库的持久可靠性)
		- 数据库事务一致性设置在较低水平，加快宕机恢复速度
		- 如果Master数据库宕机，立即将应用切换到Salve数据库，同时关闭数据写服务(即关闭词条编辑功能)
		
# 海量分布式存储系统Doris的高可用架构

- 是一个海量分布式KV存储系统，设计目的是支持中等规模高可用、可伸缩的KV存储集群。和主流的NoSQL系统HBase相比(Doris0.1 vs HBase0.90)，具有相似的性能和线性伸缩能力，并具有更好的可用性及图形用户管理界面

- 整体系统模块
	- 应用程序服务器 存储系统的客户，对系统发起数据操作请求
	- 数据存储服务器 存储系统的核心，负责存储数据、响应应用服务器的数据操作请求
	- 管理中心服务器 两天机器组成的主-主热备的小规模服务器集群，负责集群管理，对数据存储集群进行健康心跳检测，集群扩容、故障恢复管理，对应用程序服务器提供集群地址配置信息等

	只使用两份副本作为高可用策略情况下，应用程序写数据时，需要路由计算获得两台不同服务器，同时将数据写入两台服务器；而读取数据时，只需要到这两台服务器上任意一台服务器读取即可
	
- 瞬时故障 
	- 网络通讯瞬时中断、服务器内存垃圾回收或后台线程繁忙停止数据访问操作响应
	- 时间段，秒级甚至毫秒级系统可自行恢复正常响应
	- 严重性较低的故障，一般采用多次重试解决
	- 多次重试后任然失败，那可能不是瞬时故障，可能是临时故障，执行临时故障处理策略，需要请求管理中心服务器进行故障仲裁

- 临时故障
	- 交换机宕机、网卡松动导致的网络通讯中断，系统升级、停机维护等一般运维活动引起的服务关闭，内存损坏、CPU过热等硬件原因导致的服务器宕机
	- 需要人工干预，持续时间需要几十分钟甚至几小时，故障时间可分为：临时故障期间，临时故障恢复期间
	- 数据多副本，读取只需要路由选择正常机器即可，写数据时，正常服务器正常写入，故障机器将数据写入临时存储服务器，恢复之后迁移
	- 前期和临时故障处理一致，当系统出现临时故障超时或者人工确认为永久故障，系统启用备用服务器代替原来永久失效的服务器，进入永久故障恢复
- 永久故障
	- 硬盘损坏、数据丢失
	- 永久故障期间，永久故障恢复期间
	
# 网购秒杀系统架构设计案例

- 秒杀活动的技术挑战
	- 对现有网站业务造成冲击
	- 高并发下的应用、数据库负载
	- 突然增加的网络及服务器带宽
		- 假设商品页面大小200k(主要商品图片大小)，那么需要的网络和服务器带宽是2G(200k * 10000)
	- 直接下单
		- 得到下单页面的URL不用秒杀就可以下单

- 应对策略
	- 秒杀系统独立部署
	- 秒杀商品页面静态化
	- 租借秒杀活动带宽
	- 动态生成随机下单页面URL
	
- 系统架构
	- 如何控制秒杀商品页面购买按钮点亮
		- 使用js脚本控制
		- js中加入秒杀是否开始标志和下单页面URL的随机数参数
		- 秒杀开始时生成新的js文件并被用户浏览器加载
		- js使用随机版本号，不被浏览器、CDN和反向代理服务器缓存
		- 用户刷新秒杀页面 -> 页面从CDN获取 -> 每次刷新加载一次js(js服务器集群 Lighttp服务器) 
		- 定时任务服务器在秒杀开始前生成新的js并推送到js服务器
		- 这个js文件非常小，即使每次刷新都访问js文件服务器都不会有太大压力
	- 如何只允许第一个提交的订单被发送到订单子系统
		- 可以控制进入下单页面的入口，只有少数用户能进入下单页面，其他用户直接进入秒杀结束页面
		- 设置服务器集群中每天服务器接受请求的限制数量，超过则直接显示秒杀结束
		- 通过的则校验全局提交订单数量
		
# 典型故障案例

- 写日志引发的故障
	- 故障现象
		- 某应用服务器集群发布后不久就出现多台服务器相继报警，磁盘可用空间低于警戒值，并且很快有服务器宕机
		- 登录服务器发现log文件夹里的文件迅速增加，不断消耗磁盘空间
	- 原因分析
		- log输出的level全局配置为Debug
	- 经验教训
		- 应用程序自己的日志输出配置和第三方组件日志输出要分开配置
		- 检查log配置文件，日志级别至少为Warn，并且检查log输出代码调用，调用级别要符合真实日志级别
		- 有些开源第三方组件也会不恰当地输出太多Error日志，需要关闭这些日志输出
		
- 高并发访问数据库引发的故障
	- 故障现象
		- 某应用发布后，数据库Load居高不下，远超正常水平，持续报警
	- 原因分析
		- 检查数据库，发现报警因为某条SQL引起
		- SQL是简单有索引的数据查询
		- 执行频率非常高
		- 发现网页首页应用调用
	- 经验教训
		- 首页不应该访问数据库，首页需要的数据可以从缓存服务器或搜索引擎服务器获取
		- 首页最好是静态的

- 高并发情况下锁引发的故障
	- 故障现象
		- 某应用服务器不定时因为响应超时而报警，但很快又超时接触，恢复正常，如此反复
	- 原因分析
		- 程序中某个单例对象多处使用了synchronized(this)，高并发下所有请求都要排队获取这个唯一的锁。
		- 某个需要远程调用的操作也被加上了synchronized(this)，这个操作只是偶尔执行，每次执行都需要较长时间
		- 这段时间锁被占用，所有用户线程都要等待，响应超时，这个操作执行完后释放锁，其他线程迅速执行，超时解除
	- 经验教训
		- 使用锁操作要谨慎
		
- 缓存引发的故障
	- 故障现象
		- 没有新应用发布，但是数据库服务突然Load飙升，并很快失去响应
		- DBA将数据库访问切换到备机，Load也很快飙升，并失去响应
	- 原因分析
		- 缓存服务器在网站服务器集群中低位一直比较低，服务器配置和管理级别都比其他服务器要低一些
		- 认为缓存是改善性能的手段，失去一些缓存也没什么问题，有时关闭一两台缓存服务器确实没有明显影响
		- 这次一个缺乏经验的工程师关闭了缓存服务器集群中所有十几台Memcached服务器，导致网站全部瘫痪的重大事故
	- 经验教训
		- 当缓存已经不仅仅是改善性能，而成为网站架构不可或缺的一部分，对缓存的管理就需要提高到和其他服务器一样的级别
		
- 应用启动不同步引发的故障
	- 故障现象
		- 某应用发布后，服务器立即崩溃
	- 原因分析
		- 应用程序Web环境使用Apache+JBoss的模式，用户请求到Apache转发JBoss
		- 发布时，Apache和JBoss同时启动，由于JBoss启动时需要加载很多应用并初始化，花费时间长
		- JBoss还没有完全启动，Apache就已经启动完毕开始接收用户请求，大量请求阻塞在JBoss进程中，最终导致JBoss崩溃
		- 除了这种模式，还有很多类似的场景，都需要后台启动好才能启动前台应用
	- 经验教训
		- 在应用程序中加入特地的动态页面，启动脚本先启动JBoss，然后在脚本中不断用curl命令访问这个特定页面直到返回成功才启动Apache
		
- 大文件读写独占磁盘引发的故障
	- 故障现象
		- 某应用主要功能是管理用户图片，接到部分用户投诉，表示上传图片非常慢，原来只需要一两秒，现在需要几十秒，有时等半天浏览器显示服务器超时
	- 原因分析
		- 最有可能出错的地方是存储服务器
		- 检查发现大部分文件只有几百KB，而有几个文件特别大，数百兆，读写这些大文件一次需要几十秒
		- 这段时间磁盘基本被这个文件操作独占，导致其他用户的文件操作缓慢
	- 经验教训
		- 存储的使用需要根据不同类型和用途进行管理
		- 图片都是小文件不能和大文件公用存储
		- 批量处理的大文件可以使用其他类型的分布式文件系统
	
	
	