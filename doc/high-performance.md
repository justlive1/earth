网站的高性能架构

---

# 网站的性能测试

- 不同视角下的网站性能
	- 用户视角的网站性能
	    - 在浏览器上直观感受的网站响应速度
            - 计算机和网站服务器通讯时间
	        - 网站服务器处理时间
	        - 用户浏览器构造请求解析响应数据的时间
	    - 有关用户影响的因素
            - 不同计算机性能差异
	        - 不同浏览器解析html速度的差异
	        - 不同网络运营商的互联网带宽差异
	    - 在实践中的前端架构优化手段
	        - 优化页面html样式
	        - 利用浏览器并发和异步
	        - 调整浏览器缓存策略
	        - 使用CDN
	        - 反向代理
	- 开发人员视角的网站性能
	    - 技术指标
    	    - 响应延迟
    	    - 系统吞吐量
    	    - 并发处理能力
    	    - 系统稳定性
    	- 主要优化手段
    	    - 使用缓存加速数据读取
    	    - 使用集群提高吞吐能力
    	    - 使用异步加快请求响应以及实现消峰
    	    - 使用代码优化改善程序性能
    - 运维人员视角的网站性能
        - 基础设施性能和资源利用率
            - 网络运营商的带宽能力
            - 服务器硬件配置
            - 数据中心网络架构
            - 服务器和网络带宽的资源利用率
        - 主要优化手段
            - 建设优化骨干网
            - 使用高性价比定制服务器
            - 利用虚拟化技术优化资源利用
- 性能测试指标
    - 响应时间
        - 执行一个操作需要的时间，包括从发出请求到收到最后响应数据的时间
        -   操作 | 响应时间  
            ---  | ---  
            打开一个网站|几秒
            在数据库中查询一天记录（有索引）|十几毫秒
            机械磁盘一次寻址定位|4毫秒
            从机械磁盘顺序读取1MB数据|2毫秒
            从SSD磁盘顺序读取1MB数据|0.3毫秒
            从远程分布式缓存Redis读取一个数据|0.5毫秒
            从内存读取1MB数据|十几微秒
            Java程序本地方法调用|几微秒
            网络传输2KB数据|1微秒
    - 并发数
        - 系统能够同时处理请求的数目
        - 对于网站而言，并发数即网站并发用户数，指同时提交请求的用户数目
        - 与网站并发用户数相对应的还有网站在线用户数（当前登录网站的用户）和网站系统用户数（可能访问系统的用户数，多数网站就是注册用户数）
        - 网站系统用户数 > 网站在线用户数 > 网站并发用户数
        - 为了真实模拟用户行为，测试程序并不是启动多线程然后不停发送请求，而是在两次请求之间加入一个随机等待时间，这个时间称为思考时间
    - 吞吐量
        - 单位时间内系统处理的请求数量，体现系统的整体处理能力
        - 对于网站可以用“请求数/秒”或者“页面数/秒”来衡量，也可用“访问人数/天”或者“处理业务数/小时”等衡量
        - TPS（每秒事务数）HPS（每秒HPPT请求数）QPS（每秒查询数）
        - 网站优化的目的，除了改善用户体验的响应时间，还要尽量提高系统吞吐量，最大限度利用服务器资源
    - 性能计数器
        - 描述服务器或操作系统性能的一些指标
        - 包括System Load、对象与线程数、内存使用、CPU使用、磁盘与网络I/O等指标
        - System Load即系统负载，当前正在被CPU执行和等待被CPU执行的进程数目总和
            - Load的理想值是CPU的数目
            - 当Load值低于CPU数目，表示CPU有空闲，资源存在浪费
            - 当Load值高于CPU数目，表示进程在排队等待CPU调度，表示系统资源不足，影响应用程序执行性能
- 性能测试方法
    - 性能测试
        - 以系统时间初期规划的性能指标为预期目标，对系统不断施加压力，验证系统在资源可接受范围内，是否能达到性能预期
    - 负载测试
        - 对系统不断地增加并发请求以增加系统压力，直到系统的某项或多项性能指标达到安全临界值，如某种资源已经呈现饱和状态，这时继续对系统施加压力，系统的处处理能力不但不能提高，反而会下降
    - 压力测试
        - 超过安全负载的情况下，对系统继续施加压力，直到系统崩溃或不能再处理任何请求，以此获得系统最大压力承受能力
    - 稳定性测试
        - 被测试系统在特定硬件、软件、网络环境条件下，给系统加载一定业务压力，使系统运行一段较长的时间，以此检测系统是否稳定
         
- 性能优化策略
    - 性能分析
        - 检查请求处理的各个环节的日志，分析那个环节响应时间不合理、超过预期
        - 检查监控数据，分析影响性能因素，内存、磁盘、网络、CPU、代码问题、架构设计、系统资源不足
    - 性能优化

# Web前端性能优化

- 浏览器访问优化
    - 减少http请求
        - 设置Cache-Control Expires
        - 静态文件变化通过改名文件名实现
        - 使用浏览器缓存时，采用逐量更新
    - 使用浏览器缓存
    - 启用压缩
    - css方最上面，JavaScript放最下面
    - 减少cookie传输
        - 太大的cookie影响传输
        - 对于静态文件cookie没有意义，考虑独立域名
- CDN加速
- 反向代理

# 应用服务器性能优化

- 分布式缓存
- 异步操作
- 使用集群
- 代码优化

# 存储性能优化

- 机械硬盘 vs 固态硬盘
- B+树 vs LSM树
- RAID vs HDFS
